#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "draw.h"

SDL_Surface* screen;

void draw_init(int width,int height)
{
screen=SDL_SetVideoMode(width,height,32,SDL_DOUBLEBUF);
    if(screen==NULL)
    {
    printf("Failed to initialize SDL video\n");
    exit(0);
    }
}

void draw_begin()
{
SDL_LockSurface(screen);
}

void draw_end()
{
SDL_UnlockSurface(screen);
SDL_Flip(screen);
}

void draw_clear()
{
char* row=screen->pixels;
int i=screen->h;
    while(i--)
	{
	memset(row,0,4*screen->w);
	row+=screen->pitch;
	}
}

color_t get_color(unsigned char r,unsigned char g,unsigned char b)
{
return (color_t)SDL_MapRGB(screen->format,r,g,b);
}

void set_pixel(unsigned int x,unsigned int y,color_t color)
{
	if(x>=screen->w||y>=screen->h)return;
Uint32* location=(Uint32*)(screen->pixels+y*screen->pitch+x*4);
*(location)=color;
}


void draw_line(unsigned int x0, unsigned int y0,unsigned int x1,unsigned int y1,color_t color)
{
	if(x0>=screen->w||x1>=screen->w||y0>=screen->h||y1>=screen->h)return;

int steep=abs(y1-y0)>abs(x1-x0);

	if(steep)
	{
	unsigned int temp;
	temp=x0;
	x0=y0;
	y0=temp;
	temp=x1;
	x1=y1;
	y1=temp;
	}

	if(x0>x1)
	{
	unsigned int temp;
        temp=x0;
	x0=x1;
	x1=temp;
        temp=y0;
	y0=y1;
	y1=temp;
	}

int deltax=x1-x0;
int deltay=abs(y1-y0);
int error=deltax/2;
int ystep=y0<y1?1:-1;

int x;
int y=y0;
     	for(x=x0;x<=x1;x++)
	{
        	if(steep)set_pixel(y,x,color);
		else set_pixel(x,y,color);

	error-=deltay;
        	if(error<0)
		{
             	y+=ystep;
             	error+=deltax;
		}
	}
}

void draw_text(unsigned int x,unsigned int y,const char* text)
{
#define CHAR_WIDTH 5

if(x+CHAR_WIDTH*strlen(text)>screen->w||y+7>screen->h)return;

const color_t color=get_color(255,255,255);
const unsigned char bit_patterns[96*CHAR_WIDTH]={
0x00,0x00,0x00,0x00,0x00,//Space
0x00,0x00,0x7D,0x00,0x00,//!
0xFF,0xFF,0xFF,0xFF,0xFF,//?
0xFF,0xFF,0xFF,0xFF,0xFF,//#
0xFF,0xFF,0xFF,0xFF,0xFF,//$
0xFF,0xFF,0xFF,0xFF,0xFF,//%
0xFF,0xFF,0xFF,0xFF,0xFF,//&
0xFF,0xFF,0xFF,0xFF,0xFF,//'
0x00,0x1C,0x22,0x41,0x00,//(
0x00,0x41,0x22,0x1C,0x00,//)
0xFF,0xFF,0xFF,0xFF,0xFF,//*
0x08,0x08,0x3E,0x08,0x08,//+
0xFF,0xFF,0xFF,0xFF,0xFF,//,
0x08,0x08,0x08,0x08,0x08,//-
0x00,0x00,0x01,0x00,0x00,//.
0x00,0x03,0x1C,0x60,0x00,///
0x3E,0x41,0x41,0x41,0x3E,//0
0x00,0x21,0xFF,0x01,0x00,//1
0x21,0x43,0x45,0x49,0x31,//2
0x22,0x49,0x49,0x49,0x36,//3
0x0C,0x14,0x24,0xFF,0x04,//4
0x76,0x51,0x51,0x51,0x4E,//5
0x3E,0x49,0x49,0x49,0x26,//6
0x60,0x47,0x48,0x50,0x60,//7
0x36,0x49,0x49,0x49,0x36,//8
0x32,0x49,0x49,0x49,0x3E,//9
0x00,0x00,0x22,0x00,0x00,//:
0xFF,0xFF,0xFF,0xFF,0xFF,//;
0xFF,0xFF,0xFF,0xFF,0xFF,//<
0xFF,0xFF,0xFF,0xFF,0xFF,//=
0xFF,0xFF,0xFF,0xFF,0xFF,//>
0xFF,0xFF,0xFF,0xFF,0xFF,//?
0xFF,0xFF,0xFF,0xFF,0xFF,//@
0x0F,0x38,0x48,0x38,0x0F,//A
0xFF,0x49,0x49,0x36,0x00,//B
0x3E,0x41,0x41,0x41,0x22,//C
0xFF,0x41,0x41,0x41,0x3E,//D
0xFF,0x49,0x49,0x49,0x49,//E
0xFF,0x48,0x48,0x48,0x48,//F
0x3E,0x41,0x49,0x49,0x2E,//G
0xFF,0x08,0x08,0x08,0xFF,//H
0x00,0x41,0xFF,0x41,0x00,//I
0x06,0x41,0x41,0xFE,0x40,//J
0xFF,0x08,0x14,0x63,0x00,//K
0xFF,0x01,0x01,0x01,0x01,//L
0xFF,0x20,0x1F,0x20,0xFF,//M
0xFF,0x30,0x08,0x06,0xFF,//N
0x3E,0x41,0x41,0x41,0x3E,//O
0xFF,0x48,0x48,0x48,0x30,//P
0x3E,0x41,0x45,0x3E,0x01,//Q
0xFF,0x48,0x48,0x48,0x37,//R
0x32,0x49,0x49,0x49,0x26,//S
0x40,0x40,0xFF,0x40,0x40,//T
0xFE,0x01,0x01,0x01,0xFE,//U
0x78,0x06,0x01,0x06,0x78,//V
0xFF,0x01,0x0E,0x01,0xFF,//W
0x63,0x14,0x08,0x14,0x63,//X
0x40,0x30,0x0F,0x30,0x40,//Y
0x41,0x47,0x49,0x71,0x41,//Z
0xFF,0xFF,0xFF,0xFF,0xFF,//[
0x00,0x60,0x1C,0x03,0x00,/*\*/
0xFF,0xFF,0xFF,0xFF,0xFF,//]
0xFF,0xFF,0xFF,0xFF,0xFF,//^
0xFF,0xFF,0xFF,0xFF,0xFF,//_
0xFF,0xFF,0xFF,0xFF,0xFF,//`
0x16,0x29,0x29,0x29,0x1F,//a
0xFF,0x11,0x11,0x11,0x0E,//b
0x1E,0x21,0x21,0x21,0x12,//c
0x0E,0x11,0x11,0x11,0xFF,//d
0x1E,0x29,0x29,0x29,0x12,//e
0x08,0x3F,0x48,0x28,0x00,//f
0x1A,0x25,0x25,0x25,0x3E,//g
0xFF,0x08,0x10,0x10,0x0F,//h
0x00,0x11,0x5F,0x01,0x00,//i
0x02,0x01,0x11,0x5E,0x00,//j
0x00,0xFF,0x04,0x0A,0x11,//k
0x00,0x41,0xFF,0x01,0x00,//l
0x1F,0x20,0x1F,0x20,0x1F,//m
0x3F,0x10,0x20,0x20,0x1F,//n
0x1E,0x21,0x21,0x21,0x1E,//o
0x3F,0x24,0x24,0x24,0x18,//p
0x18,0x24,0x24,0x24,0x3F,//q
0x3F,0x10,0x20,0x20,0x10,//r
0x12,0x29,0x29,0x29,0x16,//s
0x10,0x3E,0x11,0x11,0x02,//t
0x3E,0x01,0x01,0x02,0x3F,//u
0x30,0x0C,0x03,0x0C,0x30,//v
0x3E,0x01,0x06,0x01,0x3E,//w
0x21,0x12,0x0C,0x12,0x21,//x
0x32,0x09,0x09,0x09,0x3E,//y
0x23,0x25,0x29,0x31,0x21,//z
0xFF,0xFF,0xFF,0xFF,0xFF,//{
0xFF,0xFF,0xFF,0xFF,0xFF,//|
0xFF,0xFF,0xFF,0xFF,0xFF,//}
0xFF,0xFF,0xFF,0xFF,0xFF,//~

};


	while(*text!=0)
	{
	short index=((short)*text-32)*CHAR_WIDTH;
		if(index<0)
		{
		text++;
		continue;
		}
	int i,j;
		for(i=0;i<CHAR_WIDTH;i++,index++)
		{
		unsigned char column=bit_patterns[index];
		//Draw column;
		int cur_y=y;
			for(j=0;j<7;j++,cur_y++)
			{
				if(column&0x40)set_pixel(x,cur_y,color);
			column<<=1;
			}
		x++;
		}
	text++;
	x++;
	}
}

unsigned int draw_get_width()
{
return screen->w;
}

unsigned int draw_get_height()
{
return screen->h;
}
